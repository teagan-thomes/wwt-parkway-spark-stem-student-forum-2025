<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Keybinds Quiz</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="../styles/styles.css">
  <link rel="stylesheet" href="../styles/quiz.css">
  <script src="../scripts/quiz-text.js" defer></script>
  <script src="../scripts/quiz-certificate.js" defer></script>
  <script src="../scripts/certificate-utils.js" defer></script>
</head>
<body>
  <!-- Header Placeholder -->
  <div id="header-placeholder"></div>

  <div class="container">
    <h1>Keybinds Quiz</h1>
    <form id="quiz-form">
      <!-- Question 1: Copy, Select All, and Paste Interaction -->
      <div class="practice-section">
        <p class="question-title">
          1. Use the keyboard shortcut to select all the text below, copy it, and then paste it into the box that follows.
        </p>
        <div style="margin-left: 20px;">
          <textarea id="q1-source" class="bordered-box" rows="8" readonly></textarea>
        </div>
        <div style="margin-left: 20px;">
          <textarea id="q1-destination" class="bordered-box" rows="8" placeholder="Paste here"></textarea>
        </div>
      </div>

      <!-- Question 2: Find Functionality -->
      <div class="practice-section">
        <p class="question-title">
          2. Use the Find function (Ctrl+F) to count occurrences:
        </p>
        <div style="margin-left: 20px;">
          <textarea id="q2-source" class="bordered-box" rows="8" readonly></textarea>
          <label for="q2-answer">How many times does the word "<span id="target-word"></span>" appear in the text above?</label>
          <input type="number" id="q2-answer" class="answer-input" placeholder="">
        </div>
        <div id="q2-feedback" class="feedback"></div>
      </div>

      <!-- Question 3: Undo and Redo Actions -->
      <div class="practice-section">
        <p class="question-title">
          3. Edit the paragraph below: delete the text, then use the undo shortcut to restore it, and finally use the redo shortcut to remove it again.
        </p>
        <div style="margin-left: 20px;">
          <p contenteditable="true" id="q3-paragraph" class="bordered-box" style="outline: none;"></p>
        </div>
      </div>

      <!-- Question 4: Scenario-Based with Interaction -->
      <div class="practice-section">
        <p class="question-title">
          4. You want to save your document quickly without using the mouse. Press the keyboard shortcut now to perform the 'Save' action.
        </p>
        <div style="margin-left: 20px;">
          <input type="text" id="q4-input" class="bordered-box" placeholder="Focus here and press the shortcut" readonly onfocus="this.blur()">
        </div>
      </div>

      <!-- Submit Button -->
      <button type="button" class="submit-button" onclick="submitQuiz()">Submit Answers</button>
    </form>

    <!-- Result Display -->
    <div id="quiz-result"></div>
  </div>

  <!-- Include the footer -->
  <div id="footer-placeholder"></div>

  <!-- Script to load header and footer -->
  <script src="../imports/loadImports.js" defer></script>

  <script>
    // Variables to store quiz answers and question data
    let quizAnswers = {
      q1SelectAll: false,
      q1CopiedText: '',
      q2: false,
      q3Undo: false,
      q3Redo: false,
      q4: false
    };

    let quizData = {
      question2: {
        targetWord: '',
        occurrences: 0
      }
    };

    // Load quiz texts when the page loads
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const texts = await loadQuizTexts();
        
        // Set question 1 text
        document.getElementById('q1-source').value = texts.question1;

        // Set question 2 text and data
        document.getElementById('q2-source').value = texts.question2.text;
        document.getElementById('target-word').textContent = texts.question2.targetWord;
        quizData.question2.targetWord = texts.question2.targetWord;
        quizData.question2.occurrences = texts.question2.occurrences;

        // Set question 3 text
        const q3Paragraph = document.getElementById('q3-paragraph');
        q3Paragraph.innerHTML = texts.question3;
        q3OriginalContent = texts.question3;
        q3History = [q3OriginalContent];
      } catch (error) {
        console.error('Error loading quiz texts:', error);
      }
    });

    // Question 1: Monitor Ctrl+A and Paste Events
    const q1Source = document.getElementById('q1-source');
    const q1Destination = document.getElementById('q1-destination');

    q1Source.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && (e.key === 'a' || e.key === 'A')) {
        quizAnswers.q1SelectAll = true;
      }
    });

    q1Destination.addEventListener('paste', function() {
      setTimeout(() => {
        quizAnswers.q1CopiedText = this.value;
      }, 100);
    });

    // Question 2: Check Answer
    document.getElementById('q2-answer').addEventListener('input', function() {
      const answer = parseInt(this.value);
      if (answer === quizData.question2.occurrences) {
        quizAnswers.q2 = true;
      } else {
        quizAnswers.q2 = false;
      }
    });

    // Question 3: Undo and Redo Actions
    let q3Paragraph = document.getElementById('q3-paragraph');
    let q3OriginalContent = q3Paragraph.innerHTML;
    let q3History = [q3OriginalContent];
    let q3CurrentIndex = 0;

    q3Paragraph.addEventListener('input', function() {
      // When new content is added, remove any redo history
      q3History = q3History.slice(0, q3CurrentIndex + 1);
      q3History.push(q3Paragraph.innerHTML);
      q3CurrentIndex = q3History.length - 1;
    });

    document.addEventListener('keydown', function(e) {
      // Undo action (Ctrl/Cmd + Z)
      if ((e.ctrlKey || e.metaKey) && !e.shiftKey && (e.key === 'z' || e.key === 'Z')) {
        e.preventDefault();
        if (q3CurrentIndex > 0) {
          q3CurrentIndex--;
          q3Paragraph.innerHTML = q3History[q3CurrentIndex];
          quizAnswers.q3Undo = true;
        }
      }
      // Redo action (Ctrl/Cmd + Shift + Z) or (Ctrl/Cmd + Y)
      else if (
        ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'z' || e.key === 'Z')) ||
        ((e.ctrlKey || e.metaKey) && (e.key === 'y' || e.key === 'Y'))
      ) {
        e.preventDefault();
        if (q3CurrentIndex < q3History.length - 1) {
          q3CurrentIndex++;
          q3Paragraph.innerHTML = q3History[q3CurrentIndex];
          quizAnswers.q3Redo = true;
        }
      }
    });

    // Question 4: Monitor Save Shortcut (Ctrl/Cmd + S)
    document.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
        e.preventDefault();
        quizAnswers.q4 = true;
        alert('Document saved successfully!');
      }
    });

    // Function to Submit Quiz
    function submitQuiz() {
      let score = 0;
      let explanations = '';

      // Question 1: Check if Ctrl+A was used and text was pasted correctly
      let originalText = q1Source.value.trim();
      if (quizAnswers.q1SelectAll && quizAnswers.q1CopiedText.trim() === originalText) {
        score += 1;
        explanations += '<p><strong>Question 1:</strong> Correct! You used Ctrl+A to select all, Ctrl+C to copy, and Ctrl+V to paste the text.</p>';
      } else if (quizAnswers.q1CopiedText.trim() === originalText) {
        explanations += '<p><strong>Question 1:</strong> Partially correct. You copied and pasted the text, but did not use Ctrl+A to select all.</p>';
      } else {
        explanations += '<p><strong>Question 1:</strong> Incorrect. Ensure you used Ctrl+A to select all the text, then Ctrl+C to copy, and Ctrl+V to paste.</p>';
      }

      // Question 2: Check if the word was highlighted
      if (quizAnswers.q2) {
        score += 1;
        explanations += '<p><strong>Question 2:</strong> Correct! You used Ctrl+F to find and highlight all occurrences of "' + quizData.question2.targetWord + '".</p>';
      } else {
        explanations += '<p><strong>Question 2:</strong> Incorrect. You needed to press Ctrl+F and search for "' + quizData.question2.targetWord + '". Be careful to not count other words that contain "' + quizData.question2.targetWord + '" inside them.</p>';
      }

      // Question 3: Check if undo and redo actions were performed
      if (quizAnswers.q3Undo && quizAnswers.q3Redo) {
        score += 1;
        explanations += '<p><strong>Question 3:</strong> Correct! You deleted the paragraph, used Ctrl+Z to undo the deletion, and then used Ctrl+Y to redo it.</p>';
      } else {
        explanations += '<p><strong>Question 3:</strong> Incorrect. You needed to delete the paragraph, undo the deletion with Ctrl+Z, and then redo it with Ctrl+Y.</p>';
      }

      // Question 4: Check if Save shortcut was used
      if (quizAnswers.q4) {
        score += 1;
        explanations += '<p><strong>Question 4:</strong> Correct! You used Ctrl+S to save the document.</p>';
      } else {
        explanations += '<p><strong>Question 4:</strong> Incorrect. You needed to press Ctrl+S to save the document.</p>';
      }

      // Display the result and explanations
      let resultElement = document.getElementById('quiz-result');
      resultElement.style.display = 'block';
      resultElement.innerHTML = 'You scored ' + score + ' out of 4!';
      resultElement.innerHTML += '<div class="explanation">' + explanations + '</div>';

      // Add certificate button if score is perfect
      if (score === 4) {
        addCertificateButton(resultElement);
      }

      // Reset the quiz after submission
      document.getElementById('quiz-form').reset();
      quizAnswers = {
        q1SelectAll: false,
        q1CopiedText: '',
        q2: false,
        q3Undo: false,
        q3Redo: false,
        q4: false
      };
      // Reset contenteditable paragraph
      q3Paragraph.innerHTML = q3OriginalContent;
    }

    // Add event listener for Ctrl+F
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && (e.key === 'f' || e.key === 'F')) {
        quizAnswers.q2 = true; // Mark question 2 as correct when Ctrl+F is used
      }
    });
  </script>

</body>
</html>